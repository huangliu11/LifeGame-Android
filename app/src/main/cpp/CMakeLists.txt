cmake_minimum_required(VERSION 3.22.1)
project(llama-android)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_C_STANDARD 11)

# ============================================
# ÁºñËØëÈÄâÈ°π
# ============================================
add_compile_options(
        -fvisibility=hidden
        -Wno-unused-function
        -Wno-unused-variable
        -Wno-deprecated-declarations
)

# ============================================
# ÂÆö‰πâÂÆè
# ============================================
add_definitions(
        -DGGML_USE_CPU
        -DGGML_BUILD=1
        -DLLAMA_BUILD=1
        -DGGML_VERSION="0.0"
        -DGGML_COMMIT="unknown"
)

# ============================================
# ËÆæÁΩÆÂü∫Á°ÄË∑ØÂæÑ
# ============================================
set(LLAMA_CPP_DIR ${CMAKE_SOURCE_DIR}/llama.cpp)

if(NOT EXISTS ${LLAMA_CPP_DIR})
    message(FATAL_ERROR "llama.cpp directory not found at: ${LLAMA_CPP_DIR}")
endif()

# ============================================
# ÂåÖÂê´ÁõÆÂΩï
# ============================================
include_directories(
        ${LLAMA_CPP_DIR}/include
        ${LLAMA_CPP_DIR}/src
        ${LLAMA_CPP_DIR}/ggml/include
        ${LLAMA_CPP_DIR}/ggml/src
        ${LLAMA_CPP_DIR}/ggml/src/ggml-cpu
        ${LLAMA_CPP_DIR}/ggml/src/ggml-cpu/arch
        ${LLAMA_CPP_DIR}/ggml/src/ggml-cpu/arch/arm
)

# ============================================
# GGML Ê†∏ÂøÉÂ∫ì
# ============================================
set(GGML_SOURCES "")

set(GGML_C_FILES
        ggml.c
        ggml-alloc.c
        ggml-quants.c
)

set(GGML_CPP_FILES
        ggml.cpp
        ggml-backend.cpp
        ggml-backend-reg.cpp
        ggml-opt.cpp
        ggml-threading.cpp
        gguf.cpp
)

foreach(file ${GGML_C_FILES})
    set(filepath ${LLAMA_CPP_DIR}/ggml/src/${file})
    if(EXISTS ${filepath})
        list(APPEND GGML_SOURCES ${filepath})
        message(STATUS "‚úÖ GGML C: ${file}")
    endif()
endforeach()

foreach(file ${GGML_CPP_FILES})
    set(filepath ${LLAMA_CPP_DIR}/ggml/src/${file})
    if(EXISTS ${filepath})
        list(APPEND GGML_SOURCES ${filepath})
        message(STATUS "‚úÖ GGML C++: ${file}")
    endif()
endforeach()

if(NOT GGML_SOURCES)
    message(FATAL_ERROR "‚ùå No GGML source files found!")
endif()

add_library(ggml STATIC ${GGML_SOURCES})

target_include_directories(ggml PUBLIC
        ${LLAMA_CPP_DIR}/ggml/include
        ${LLAMA_CPP_DIR}/ggml/src
)

target_compile_options(ggml PRIVATE
        -fexceptions
        -frtti
)

# ============================================
# GGML CPU ÂêéÁ´Ø - ÂåÖÂê´ÊâÄÊúâÂÆûÁé∞Êñá‰ª∂
# ============================================
set(GGML_CPU_SOURCES "")

# ‰∏ª ggml-cpu ÁõÆÂΩï‰∏ãÁöÑÊâÄÊúâÊñá‰ª∂
set(GGML_CPU_MAIN_FILES
        ggml-cpu.c
        ggml-cpu.cpp
        binary-ops.cpp
        hbm.cpp
        ops.cpp          # ‚Üê ÂÖ≥ÈîÆÔºÅÂåÖÂê´ÊâÄÊúâ compute_forward ÂáΩÊï∞
        quants.c
        repack.cpp
        traits.cpp
        unary-ops.cpp
        vec.cpp
)

message(STATUS "")
message(STATUS "üîç Adding ggml-cpu main files:")
foreach(file ${GGML_CPU_MAIN_FILES})
    set(filepath ${LLAMA_CPP_DIR}/ggml/src/ggml-cpu/${file})
    if(EXISTS ${filepath})
        list(APPEND GGML_CPU_SOURCES ${filepath})
        file(SIZE ${filepath} filesize)
        math(EXPR filesize_kb "${filesize} / 1024")
        message(STATUS "  ‚úÖ ${file} (${filesize_kb}KB)")
    else()
        message(WARNING "  ‚ö†Ô∏è  Missing: ${file}")
    endif()
endforeach()

# ARM Êû∂ÊûÑÁâπÂÆöÊñá‰ª∂
set(GGML_CPU_ARM_FILES
        arch/arm/cpu-feats.cpp
        arch/arm/quants.c
        arch/arm/repack.cpp
)

message(STATUS "")
message(STATUS "üîç Adding ARM arch files:")
foreach(file ${GGML_CPU_ARM_FILES})
    set(filepath ${LLAMA_CPP_DIR}/ggml/src/ggml-cpu/${file})
    if(EXISTS ${filepath})
        list(APPEND GGML_CPU_SOURCES ${filepath})
        file(SIZE ${filepath} filesize)
        math(EXPR filesize_kb "${filesize} / 1024")
        message(STATUS "  ‚úÖ ${file} (${filesize_kb}KB)")
    else()
        message(WARNING "  ‚ö†Ô∏è  Missing: ${file}")
    endif()
endforeach()

if(NOT GGML_CPU_SOURCES)
    message(FATAL_ERROR "‚ùå No ggml-cpu sources found!")
endif()

list(LENGTH GGML_CPU_SOURCES CPU_COUNT)
message(STATUS "")
message(STATUS "‚úÖ Total ggml-cpu sources: ${CPU_COUNT} files")

add_library(ggml-cpu STATIC ${GGML_CPU_SOURCES})

target_include_directories(ggml-cpu PUBLIC
        ${LLAMA_CPP_DIR}/ggml/include
        ${LLAMA_CPP_DIR}/ggml/src
        ${LLAMA_CPP_DIR}/ggml/src/ggml-cpu
        ${LLAMA_CPP_DIR}/ggml/src/ggml-cpu/arch
        ${LLAMA_CPP_DIR}/ggml/src/ggml-cpu/arch/arm
)

target_compile_options(ggml-cpu PRIVATE
        -fexceptions
        -frtti
)

# ÈìæÊé• ggml
target_link_libraries(ggml-cpu PUBLIC ggml)

# ============================================
# LLAMA Â∫ì
# ============================================
file(GLOB LLAMA_SOURCES "${LLAMA_CPP_DIR}/src/llama*.cpp")
file(GLOB UNICODE_SOURCES "${LLAMA_CPP_DIR}/src/unicode*.cpp")
file(GLOB LLAMA_MODEL_SOURCES "${LLAMA_CPP_DIR}/src/models/*.cpp")

set(ALL_LLAMA_SOURCES ${LLAMA_SOURCES} ${UNICODE_SOURCES} ${LLAMA_MODEL_SOURCES})

if(NOT ALL_LLAMA_SOURCES)
    message(FATAL_ERROR "‚ùå No LLAMA source files found!")
endif()

list(LENGTH ALL_LLAMA_SOURCES LLAMA_COUNT)
message(STATUS "‚úÖ Found ${LLAMA_COUNT} LLAMA source files")

add_library(llama STATIC ${ALL_LLAMA_SOURCES})

target_include_directories(llama PUBLIC
        ${LLAMA_CPP_DIR}/include
        ${LLAMA_CPP_DIR}/src
)

target_link_libraries(llama PUBLIC ggml ggml-cpu)

target_compile_options(llama PRIVATE
        -fexceptions
        -frtti
)

# ============================================
# Android JNI Â∫ì
# ============================================
set(JNI_SOURCE ${CMAKE_SOURCE_DIR}/llama-android.cpp)

if(NOT EXISTS ${JNI_SOURCE})
    message(FATAL_ERROR "‚ùå JNI source not found: ${JNI_SOURCE}")
endif()

message(STATUS "‚úÖ Found JNI source: llama-android.cpp")

add_library(llama-android SHARED ${JNI_SOURCE})

target_link_libraries(llama-android
        llama
        ggml-cpu
        ggml
        android
        log
)

target_compile_options(llama-android PRIVATE
        -fexceptions
        -frtti
)

# ============================================
# ÊâìÂç∞ÊúÄÁªàÈÖçÁΩÆ
# ============================================
message(STATUS "")
message(STATUS "===========================================")
message(STATUS "üì¶ LLAMA Android Build Configuration")
message(STATUS "===========================================")
message(STATUS "üìÅ LLAMA_CPP_DIR: ${LLAMA_CPP_DIR}")
list(LENGTH GGML_SOURCES GGML_COUNT)
message(STATUS "üìÑ GGML sources: ${GGML_COUNT} files")
list(LENGTH GGML_CPU_SOURCES GGML_CPU_COUNT)
message(STATUS "üìÑ GGML CPU sources: ${GGML_CPU_COUNT} files")
message(STATUS "üìÑ LLAMA sources: ${LLAMA_COUNT} files")
message(STATUS "‚úÖ Target: ARM64 (aarch64)")
message(STATUS "‚úÖ Exceptions: ENABLED")
message(STATUS "‚úÖ RTTI: ENABLED")
message(STATUS "===========================================")
message(STATUS "")